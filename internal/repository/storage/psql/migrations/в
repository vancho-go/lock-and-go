CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Создание таблицы пользователей
CREATE TABLE IF NOT EXISTS users (
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(255) UNIQUE NOT NULL,
    password_hash CHAR(60) NOT NULL,
    email VARCHAR(255) UNIQUE,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT (now() AT TIME ZONE 'Europe/Moscow'),
    last_login TIMESTAMP WITHOUT TIME ZONE
);

-- Создание таблицы типов данных
CREATE TABLE IF NOT EXISTS data_types (
    type_id SERIAL PRIMARY KEY,
    type_name VARCHAR(50) UNIQUE NOT NULL
);

-- Заполнение таблицы типов данных начальными значениями
INSERT INTO data_types (type_name) VALUES
    ('login/password'),
    ('text'),
    ('binary'),
    ('card')
ON CONFLICT (type_name) DO NOTHING;

-- Создание основной таблицы для хранения зашифрованных данных пользователя
CREATE TABLE IF NOT EXISTS encrypted_user_data (
    data_id SERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    type_id INT NOT NULL REFERENCES data_types(type_id) ON DELETE RESTRICT,
    encrypted_data BYTEA NOT NULL, -- Зашифрованные данные
    version INT NOT NULL DEFAULT 1,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT (now() AT TIME ZONE 'Europe/Moscow'),
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT (now() AT TIME ZONE 'Europe/Moscow'),
    comment TEXT -- Необязательное поле для комментариев
);
